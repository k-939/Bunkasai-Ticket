<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>展示側 受付ツール</title>
  <link rel="stylesheet" href="../../assets/main.css" />
  <script src="../../assets/jsQR.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
  <h1>受付用ページ(prototype)</h1>

  <div id="auth" class="card">
    <h3>ログイン</h3>
    <div class="row"><label>メール <input id="email" type="email" placeholder="exhibit-01@example.com"></label></div>
    <div class="row"><label>パスワード <input id="password" type="password"></label></div>
    <div class="row">
      <button id="loginBtn">ログイン</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </div>

  <div id="app" class="card" style="display:none">
    <div class="row">
      <button id="logoutBtn">ログアウト</button>
      <span id="who" class="muted"></span>
    </div>

    <h3>予約の割り当て</h3>
     <canvas id="canvas" style="width:100%"></canvas>
    
    <div class="row">
      <strong>展示</strong>:
      <span id="exhibitLabel" class="mono"></span>
      <span id="exhibitWarn" class="err"></span>
    </div>
    <div class="row"><label id="qrLabel">QR ID <input id="qr" size="40" placeholder="スキャン or 入力"></label></div>
    <div class="row"><label>時刻 <input id="time" type="datetime-local"></label></div>
    <div class="row">
      <label>状態
        <select id="status">
          <option value="assigned">assigned</option>
          <option value="completed">completed</option>
          <option value="canceled">canceled</option>
        </select>
      </label>
    </div>
    <div class="row">
      <button id="assignBtn">登録</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const SUPABASE_URL = 'https://ktlrdrdpjgdehpayjbrs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0bHJkcmRwamdkZWhwYXlqYnJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc1NjEsImV4cCI6MjA3NDgyMzU2MX0.SCh9aOh7Pw18G9oxSYm1F1fTKTSps-c77qyIJn17FmE';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    const authBox = document.getElementById('auth');
    const appBox = document.getElementById('app');
    const who = document.getElementById('who');
    const authMsg = document.getElementById('authMsg');
    const msg = document.getElementById('msg');
    const exhibitLabel = document.getElementById('exhibitLabel');
    const exhibitWarn = document.getElementById('exhibitWarn');

    let currentExhibit = null; // { id, slug, name }

    async function loadMyExhibit() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return null;
      // 自分のprofilesを取得
      const { data: prof, error: pErr } = await supabase
        .from('profiles')
        .select('role, exhibit_id')
        .eq('user_id', user.id)
        .single();
      if (pErr) { exhibitWarn.textContent = 'profiles取得エラー: ' + pErr.message; return null; }
      if (!prof || prof.role !== 'exhibit' || !prof.exhibit_id) {
        exhibitWarn.textContent = 'このユーザーには展示が割り当てられていません';
        return null;
      }
      const { data: ex, error: eErr } = await supabase
        .from('exhibits')
        .select('id, slug, name, active')
        .eq('id', prof.exhibit_id)
        .single();
      if (eErr) { exhibitWarn.textContent = 'exhibits取得エラー: ' + eErr.message; return null; }
      if (!ex.active) { exhibitWarn.textContent = 'この展示は非アクティブです'; }
      exhibitLabel.textContent = `${ex.slug} (${ex.name})`;
      currentExhibit = ex;
      return ex;
    }

    async function refreshUI() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        authBox.style.display = 'none';
        appBox.style.display = '';
        who.textContent = `ログイン中: ${user.email}`;
        await loadMyExhibit();
      } else {
        authBox.style.display = '';
        appBox.style.display = 'none';
        who.textContent = '';
        exhibitLabel.textContent = '';
        currentExhibit = null;
      }
    }
    refreshUI();
    
      var video = document.createElement("video");
      var canvasElement = document.getElementById("canvas");
      var canvas = canvasElement.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(function(stream) {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          requestAnimationFrame(tick);
      });
	
      function tick() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvasElement.height = video.videoHeight;
              canvasElement.width = video.videoWidth;
              canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
              var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
              var code = jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: "dontInvert",
              });
              if (code) {
                  document.getElementById("qr").value = code.data;
          }
          requestAnimationFrame(tick);
      }
    }

    document.getElementById('password').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') { document.getElementById('loginBtn').click(); }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      authMsg.textContent = 'ログイン中…';
      const email = (document.getElementById('email')).value;
      const password = (document.getElementById('password')).value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      authMsg.textContent = error ? 'エラー: ' + error.message : 'OK';
      await refreshUI();
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      msg.textContent = '';
      await refreshUI();
    });

    document.getElementById('time').value = new Date().toISOString().slice(0,16);

    document.getElementById('assignBtn').addEventListener('click', async () => {
      msg.className = 'muted';
      msg.textContent = '送信中…';

      const qr = (document.getElementById('qr')).value.trim();
      const at_time_local = (document.getElementById('time')).value;
      const new_status = (document.getElementById('status')).value;
      if (!qr || !currentExhibit || !at_time_local) { msg.textContent = '入力不足です'; return; }

      const iso = new Date(at_time_local).toISOString();

      const { data, error } = await supabase.rpc('assign_reservation', {
        qr,
        exhibit_slug: currentExhibit.slug,
        at_time: iso,
        new_status
      });
      if (error) {
        msg.className = 'err';
        msg.textContent = 'エラー: ' + error.message;
      } else {
        msg.className = 'ok';
        msg.textContent = `登録: ID:${data.qr_id} / 展示:${currentExhibit.slug} / 時間:${new Date(data.reservation_time).toLocaleString()}`;
      }
    });
  </script>
</body>
</html>
